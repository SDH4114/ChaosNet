<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChaosNet - Select Room</title>
  <link rel="icon" type="image/png" href="img/ChaosNetLogo.png" />
  <link rel="shortcut icon" href="img/ChaosNetLogo.png" type="image/png"/>
  <link rel="stylesheet" href="css/mainStyle.css" />
    <!-- iOS home screen icon + web app meta -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" href="/img/ChaosNetLogo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ChaosNet">
  <meta name="viewport" content="width=device-width, initial-scale=0.8">

</head>
<body>
<button onclick="logOut()" 
  style="position: fixed; top: 10px; right: 10px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Log out
</button>
<button onclick="goToSettings()" 
  style="position: fixed; top: 10px; right: 110px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Settings
</button>
<button id="adminBtn" onclick="goToAdminPanel()" 
  style="display: none; position: fixed; top: 10px; right: 220px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Admin Panel
</button>
  <div class="login-container">
    <h2>Select Room</h2>
    <form id="roomForm">
      <input type="text" id="roomName" placeholder="Room ID" required />
      <button type="submit">Join</button>
    </form>

    <div class="list" id="recentRooms">
      <h3>Recent Rooms</h3>
      <div id="roomsList"></div>
    </div>
  </div>

  <script>
  // === Push subscription for ALL recent rooms (select.html) ===
  // Public VAPID key is injected by server at runtime.
  window.VAPID_PUBLIC_KEY = window.VAPID_PUBLIC_KEY || '[[VAPID_PUBLIC_KEY_REPLACED_AT_RUNTIME]]';

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  async function ensureSWAndSubscription() {
    if (!('serviceWorker' in navigator)) return null;
    const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
    try {
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission().catch(() => {});
      }
    } catch (_) {}
    if (!reg.pushManager) return null;

    const appServerKey = window.VAPID_PUBLIC_KEY ? urlBase64ToUint8Array(window.VAPID_PUBLIC_KEY) : null;
    if (!appServerKey) {
      console.warn('VAPID public key is not set on client.');
      return null;
    }

    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      try {
        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
      } catch (e) {
        console.warn('Push subscription failed:', e);
        return null;
      }
    }
    return sub.toJSON ? sub.toJSON() : sub;
  }

  function getRecentRooms() {
    try {
      const arr = JSON.parse(localStorage.getItem('rooms')) || [];
      return Array.isArray(arr) ? arr : [];
    } catch (_) {
      return [];
    }
  }

  async function subscribeRooms(rooms) {
    rooms = Array.from(new Set((rooms || []).filter(Boolean)));
    if (!rooms.length) return;

    const subscription = await ensureSWAndSubscription();
    if (!subscription) return;

    const uid = localStorage.getItem('userid') || localStorage.getItem('userID') || null;
    const nick = localStorage.getItem('username') || null;

    // сервер принимает одну комнату — шлём по одной записи
    await Promise.allSettled(
      rooms.map((roomId) =>
        fetch('/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subscription,
            room: roomId,
            userId: uid,
            nick
          })
        }).catch(() => {})
      )
    );
  }

  // Автоподписка при открытии "Select Room": подписываемся на все недавние
  document.addEventListener('DOMContentLoaded', () => {
    const recent = getRecentRooms();
    if (recent.length) {
      subscribeRooms(recent);
    }
  });

  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('message', (event) => {
      const msg = event.data || {};
      if (msg.type === 'openedFromNotification') {
        const room = msg.room || 'main';
        window.location.href = `chat.html?room=${encodeURIComponent(room)}`;
      } else if (msg.type === 'openQuickReply') {
        // будет обработано модулем Quick Reply (он слушает то же событие и откроет модал)
        // намеренно ничего не делаем здесь
      }
    });
  }

    function logOut() {
      localStorage.removeItem('username');
      localStorage.removeItem('userid');
      window.location.href = "login.html";
    }
    document.getElementById('roomForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const input = document.getElementById('roomName');
      const room = input.value.trim();

      if (room.toLowerCase() === '/clear') {
        localStorage.removeItem('rooms');
        document.getElementById('roomsList').innerHTML = '';
        input.value = '';
        alert("Recent rooms cleared");
        return;
      }

      if (room) {
        saveToStorage('rooms', room);
        window.location.href = `chat.html?room=${encodeURIComponent(room)}`;
      }
    });

    function saveToStorage(key, value) {
      let items = JSON.parse(localStorage.getItem(key)) || [];
      if (!items.includes(value)) {
        items.unshift(value);
        if (items.length > 10) items = items.slice(0, 10);
        localStorage.setItem(key, JSON.stringify(items));
      }
      // Автоподписка на только что добавленную комнату
      if (key === 'rooms') {
        try { subscribeRooms([value]); } catch (_) {}
      }
    }

    function renderList(id, key) {
      const container = document.getElementById(id);
      const items = JSON.parse(localStorage.getItem(key)) || [];
      container.innerHTML = items.map(item => `
        <div class="list-item">
          <a href="chat.html?room=${encodeURIComponent(item)}" class="link-underline">${item}</a>
        </div>
      `).join('');
    }

    function goToAdminPanel() {
      window.location.href = "adminPanel.html";
    }

    function goToSettings() {
      window.location.href = "settings.html";
    }

    const currentUserId = localStorage.getItem('userID');
    if (currentUserId) {
      fetch('/check-admin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: currentUserId })
      })
      .then(res => res.json())
      .then(data => {
        if (Boolean(data.admin)) {
          document.getElementById('adminBtn').style.display = 'inline-block';
        }
      })
      .catch(err => {
        console.error("Failed to check admin:", err);
      });
    }

    renderList('roomsList', 'rooms');
  </script>
  <div id="qrModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#1f1f1f; padding:16px; border-radius:10px; width:min(520px, 92vw); box-shadow:0 10px 24px rgba(0,0,0,.35);">
      <div style="font-weight:600; color:#ff8c00; margin-bottom:8px;">Quick Reply</div>
      <div style="font-size:13px; color:#bbb; margin-bottom:8px;">Room: <span id="qrRoom" style="color:#fff">main</span></div>
      <form id="qrForm">
        <textarea id="qrText" rows="3" placeholder="Type your reply…" style="width:100%; resize:vertical; background:#2a2a2a; color:#fff; border:1px solid #444; border-radius:8px; padding:10px;"></textarea>
        <div style="display:flex; gap:8px; margin-top:10px; justify-content:flex-end;">
          <button type="button" id="qrCancel" style="background:#333; color:#ddd; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Cancel</button>
          <button type="submit" id="qrSend" style="background:#ff8c00; color:#000; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Send</button>
        </div>
      </form>
    </div>
  </div>
  <script>
  // === Quick Reply support (opened from push "Reply" action) ===
  (function(){
    const modal = document.getElementById('qrModal');
    const qrRoomEl = document.getElementById('qrRoom');
    const qrText = document.getElementById('qrText');
    const qrForm = document.getElementById('qrForm');
    const qrCancel = document.getElementById('qrCancel');

    function openQR(room){
      try { qrRoomEl.textContent = room || 'main'; } catch(_){}
      try { qrText.value = ''; } catch(_){}
      modal.style.display = 'flex';
      setTimeout(() => { try { qrText.focus(); } catch(_){} }, 0);
    }
    function closeQR(){
      modal.style.display = 'none';
    }

    // If SW opens us with ?reply=1&room=XXX — open modal automatically
    try{
      const usp = new URLSearchParams(location.search);
      if (usp.get('reply') === '1'){
        openQR(usp.get('room') || 'main');
      }
    } catch(_){}

    // Listen messages from Service Worker
    if (navigator.serviceWorker){
      navigator.serviceWorker.addEventListener('message', (event) => {
        const msg = event.data || {};
        if (msg.type === 'openQuickReply'){
          openQR(msg.room || 'main');
        }
      });
    }

    qrCancel && qrCancel.addEventListener('click', closeQR);

    qrForm && qrForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (qrText.value || '').trim();
      if (!text) return;
      const room = (qrRoomEl.textContent || 'main');
      const userId = localStorage.getItem('userid') || localStorage.getItem('userID') || null;
      const nick = localStorage.getItem('username') || 'guest';
      try{
        const r = await fetch('/push/reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ room, text, userId, nick })
        });
        if (!r.ok){
          const t = await r.text().catch(() => '');
          alert('Send failed: ' + (t || r.status));
          return;
        }
        // Lightweight confirmation (stay on select page)
        try {
          // optional toast — minimal
          const ok = document.createElement('div');
          ok.textContent = 'Sent';
          ok.style.cssText = 'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#2b2b2b;color:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:10000;';
          document.body.appendChild(ok);
          setTimeout(() => ok.remove(), 1200);
        } catch(_){}
        closeQR();
      } catch (err){
        alert('Network error');
      }
    });
  })();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChaosNet - Select Room</title>
  <link rel="icon" type="image/png" href="img/ChaosNetLogo.png" />
  <link rel="shortcut icon" href="img/ChaosNetLogo.png" type="image/png"/>
  <link rel="stylesheet" href="css/mainStyle.css" />
    <!-- iOS home screen icon + web app meta -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" href="/img/ChaosNetLogo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ChaosNet">
  <meta name="viewport" content="width=device-width, initial-scale=0.8">

</head>
<body>
<button onclick="logOut()" 
  style="position: fixed; top: 10px; right: 10px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Log out
</button>
<button onclick="goToSettings()" 
  style="position: fixed; top: 10px; right: 110px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Settings
</button>
<button id="adminBtn" onclick="goToAdminPanel()" 
  style="display: none; position: fixed; top: 10px; right: 220px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Admin Panel
</button>
  <div class="login-container">
    <h2>Select Room</h2>
    <form id="roomForm">
      <input type="text" id="roomName" placeholder="Room ID" required />
      <button type="submit">Join</button>
    </form>

    <div class="list" id="recentRooms">
      <h3>Rooms</h3>
      <div id="roomsList"></div>
    </div>
  </div>

  <script>
  // === Push subscription for ALL recent rooms (select.html) ===
  // Public VAPID key is injected by server at runtime.
  window.VAPID_PUBLIC_KEY = window.VAPID_PUBLIC_KEY || '[[VAPID_PUBLIC_KEY_REPLACED_AT_RUNTIME]]';

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }
  function _unreadKey() {
    const uid = localStorage.getItem('userid') || localStorage.getItem('userID') || '';
    return 'unreadByRoom:' + uid;
  }
  function getUnreadMap() {
    try { return JSON.parse(localStorage.getItem(_unreadKey())) || {}; } catch(_) { return {}; }
  }
  function setUnreadMap(map) {
    try { localStorage.setItem(_unreadKey(), JSON.stringify(map || {})); } catch(_) {}
  }
  function incUnread(room) {
    const m = getUnreadMap();
    m[room] = (m[room] || 0) + 1;
    setUnreadMap(m);
    renderList('roomsList', window.__roomsCache || []);
  }
  function clearUnread(room) {
    const m = getUnreadMap();
    if (m[room]) { delete m[room]; setUnreadMap(m); }
    renderList('roomsList', window.__roomsCache || []);
  }

  async function fetchServerRooms(userId) {
    try {
      if (!userId) return [];
      const res = await fetch('/push/list?userId=' + encodeURIComponent(userId), { method: 'GET' });
      if (!res.ok) return [];
      const json = await res.json().catch(() => ({}));
      const arr = Array.isArray(json.rooms) ? json.rooms : [];
      // unique + non-empty strings only
      return Array.from(new Set(arr.filter(Boolean)));
    } catch (_) {
      return [];
    }
  }

  async function ensureSWAndSubscription() {
    if (!('serviceWorker' in navigator)) return null;
    const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
    try {
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission().catch(() => {});
      }
    } catch (_) {}
    if (!reg.pushManager) return null;

    const appServerKey = window.VAPID_PUBLIC_KEY ? urlBase64ToUint8Array(window.VAPID_PUBLIC_KEY) : null;
    if (!appServerKey) {
      console.warn('VAPID public key is not set on client.');
      return null;
    }

    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      try {
        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
      } catch (e) {
        console.warn('Push subscription failed:', e);
        return null;
      }
    }
    return sub.toJSON ? sub.toJSON() : sub;
  }

  function getRecentRooms() {
    // Deprecated: kept for backward compatibility (returns empty; use loadRoomsFromServer instead)
    return [];
  }

  async function subscribeRooms(rooms) {
    rooms = Array.from(new Set((rooms || []).filter(Boolean)));
    if (!rooms.length) return;

    const subscription = await ensureSWAndSubscription();
    if (!subscription) return;

    const uid = localStorage.getItem('userid') || localStorage.getItem('userID') || null;
    const nick = localStorage.getItem('username') || null;

    // сервер принимает одну комнату — шлём по одной записи
    await Promise.allSettled(
      rooms.map((roomId) =>
        fetch('/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subscription,
            room: roomId,
            userId: uid,
            nick
          })
        }).catch(() => {})
      )
    );
  }

  // При открытии Select: получаем список комнат с сервера для текущего пользователя
  document.addEventListener('DOMContentLoaded', async () => {
    const uid = localStorage.getItem('userid') || localStorage.getItem('userID') || null;
    const rooms = await fetchServerRooms(uid);
    renderList('roomsList', rooms);
    // гарантируем, что пуш-подписка оформлена для всех этих комнат (идемпотентно)
    if (rooms.length) {
      try { await subscribeRooms(rooms); } catch (_) {}
    }
  });

  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('message', (event) => {
      const msg = event.data || {};
      if (msg.type === 'openedFromNotification') {
        const room = msg.room || 'main';
        window.location.href = `chat.html?room=${encodeURIComponent(room)}`;
      } else if (msg.type === 'openQuickReply') {
        // будет обработано модулем Quick Reply (он слушает то же событие и откроет модал)
        // намеренно ничего не делаем здесь
      }
    });
  }
  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('message', (event) => {
      const msg = event.data || {};
      if (msg.type === 'roomHasNew' && msg.room) {
        incUnread(msg.room);
      } else if (msg.type === 'openedFromNotification' && msg.room) {
        clearUnread(msg.room);
        window.location.href = `chat.html?room=${encodeURIComponent(msg.room)}`;
      }
    });
  }

    function logOut() {
      localStorage.removeItem('username');
      localStorage.removeItem('userid');
      window.location.href = "login.html";
    }
    document.getElementById('roomForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const input = document.getElementById('roomName');
      const room = (input.value || '').trim();

      if (!room) return;

      // (optional) поддержка команды /clear теперь не трогает localStorage
      if (room.toLowerCase() === '/clear') {
        alert("Clearing server-side recent rooms is not supported here. Ask admin or unsubscribe per room.");
        input.value = '';
        return;
      }

      // оформляем/обновляем подписку на эту комнату на сервере
      try { await subscribeRooms([room]); } catch (_) {}

      // навигируем в комнату
      window.location.href = `chat.html?room=${encodeURIComponent(room)}`;
    });

    function saveToStorage(key, value) {
      // Deprecated: rooms are kept on server in push_subscriptions.
      if (key === 'rooms' && value) {
        try { subscribeRooms([value]); } catch (_) {}
      }
    }

    function renderList(id, items) {
      const container = document.getElementById(id);
      const list = Array.isArray(items) ? items : [];
      window.__roomsCache = list.slice();
      const unread = getUnreadMap();
      container.innerHTML = list.map(roomId => {
        const hasUnread = !!unread[roomId];
        const dot = hasUnread ? '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ff8c00;margin-left:8px;vertical-align:middle;" aria-label="new messages"></span>' : '';
        return `
          <div class="list-item">
            <a href="#" data-room="${roomId}" class="room-link link-underline">${roomId}${dot}</a>
          </div>
        `;
      }).join('');
      // attach click handlers to clear unread before navigating
      container.querySelectorAll('.room-link').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const r = a.getAttribute('data-room');
          clearUnread(r);
          window.location.href = 'chat.html?room=' + encodeURIComponent(r);
        });
      });
    }

    function goToAdminPanel() {
      window.location.href = "adminPanel.html";
    }

    function goToSettings() {
      window.location.href = "settings.html";
    }

    const currentUserId = localStorage.getItem('userID');
    if (currentUserId) {
      fetch('/check-admin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: currentUserId })
      })
      .then(res => res.json())
      .then(data => {
        if (Boolean(data.admin)) {
          document.getElementById('adminBtn').style.display = 'inline-block';
        }
      })
      .catch(err => {
        console.error("Failed to check admin:", err);
      });
    }

    (async () => {
      const uid = localStorage.getItem('userid') || localStorage.getItem('userID') || null;
      const rooms = await fetchServerRooms(uid);
      renderList('roomsList', rooms);
      // re-apply badges upon load
      renderList('roomsList', rooms);
    })();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChaosNet - Select Room</title>
  <link rel="icon" type="image/png" href="img/ChaosNetLogo.png" />
  <link rel="shortcut icon" href="img/ChaosNetLogo.png" type="image/png"/>
  <link rel="stylesheet" href="css/mainStyle.css" />
    <!-- iOS home screen icon + web app meta -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" href="/img/ChaosNetLogo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ChaosNet">
  <meta name="viewport" content="width=device-width, initial-scale=0.8">

</head>
<body>
<button onclick="logOut()" 
  style="position: fixed; top: 10px; right: 10px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Log out
</button>
<button onclick="goToSettings()" 
  style="position: fixed; top: 10px; right: 110px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Settings
</button>
<button id="adminBtn" onclick="goToAdminPanel()" 
  style="display: none; position: fixed; top: 10px; right: 220px; 
         background-color: #2b2b2b; 
         color: #ff8c00; 
         border: none; 
         padding: 8px 14px; 
         border-radius: 8px; 
         cursor: pointer; 
         font-size: 14px; 
         width: auto; 
         box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);">
  Admin Panel
</button>
  <div class="login-container">
    <h2>Select Room</h2>
    <form id="roomForm">
      <input type="text" id="roomName" placeholder="Room ID" required />
      <button type="submit">Join</button>
    </form>

    <div class="list" id="recentRooms">
      <h3>Recent Rooms</h3>
      <div id="roomsList"></div>
    </div>
  </div>

  <script>
  // === Push subscription for ALL recent rooms (select.html) ===
  // Public VAPID key is injected by server at runtime.
  window.VAPID_PUBLIC_KEY = window.VAPID_PUBLIC_KEY || '[[VAPID_PUBLIC_KEY_REPLACED_AT_RUNTIME]]';

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }
  function _unreadKey() {
    const uid = localStorage.getItem('userid') || localStorage.getItem('userID') || '';
    return 'unreadByRoom:' + uid;
  }
  function getUnreadMap() {
    try { return JSON.parse(localStorage.getItem(_unreadKey())) || {}; } catch(_) { return {}; }
  }
  function setUnreadMap(map) {
    try { localStorage.setItem(_unreadKey(), JSON.stringify(map || {})); } catch(_) {}
  }
  function incUnread(room) {
    if (!room) return;
    const m = getUnreadMap();
    m[room] = (m[room] || 0) + 1;
    setUnreadMap(m);
    // re-render list to reflect updated counter
    renderList('roomsList', 'rooms');
  }
  function clearUnread(room) {
    if (!room) return;
    const m = getUnreadMap();
    if (m[room]) { delete m[room]; setUnreadMap(m); }
    // re-render list to reflect updated counter
    renderList('roomsList', 'rooms');
  }
  // Backward-compat shim for older SW posts
  function markRoomHasUnread(room){
    incUnread(room);
  }

  async function ensureSWAndSubscription() {
    if (!('serviceWorker' in navigator)) return null;
    const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
    try {
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission().catch(() => {});
      }
    } catch (_) {}
    if (!reg.pushManager) return null;

    const appServerKey = window.VAPID_PUBLIC_KEY ? urlBase64ToUint8Array(window.VAPID_PUBLIC_KEY) : null;
    if (!appServerKey) {
      console.warn('VAPID public key is not set on client.');
      return null;
    }

    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      try {
        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
      } catch (e) {
        console.warn('Push subscription failed:', e);
        return null;
      }
    }
    return sub.toJSON ? sub.toJSON() : sub;
  }

  function getRecentRooms() {
    try {
      const arr = JSON.parse(localStorage.getItem('rooms')) || [];
      return Array.isArray(arr) ? arr : [];
    } catch (_) {
      return [];
    }
  }

  async function subscribeRooms(rooms) {
    rooms = Array.from(new Set((rooms || []).filter(Boolean)));
    if (!rooms.length) return;

    const subscription = await ensureSWAndSubscription();
    if (!subscription) return;

    const uid = localStorage.getItem('userid') || localStorage.getItem('userID') || null;
    const nick = localStorage.getItem('username') || null;

    // сервер принимает одну комнату — шлём по одной записи
    await Promise.allSettled(
      rooms.map((roomId) =>
        fetch('/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subscription,
            room: roomId,
            userId: uid,
            nick
          })
        }).catch(() => {})
      )
    );
  }

  // Автоподписка при открытии "Select Room": подписываемся на все недавние
  document.addEventListener('DOMContentLoaded', () => {
    const recent = getRecentRooms();
    if (recent.length) {
      subscribeRooms(recent);
    }
  });

  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('message', (event) => {
      const msg = event.data || {};
      if (msg.type === 'openedFromNotification') {
        const room = msg.room || 'main';
        window.location.href = `chat.html?room=${encodeURIComponent(room)}`;
      } else if (msg.type === 'openQuickReply') {
        // будет обработано модулем Quick Reply (он слушает то же событие и откроет модал)
        // намеренно ничего не делаем здесь
      }
    });
  }
  if (navigator.serviceWorker) {
    navigator.serviceWorker.addEventListener('message', (event) => {
      const msg = event.data || {};
      if (msg.type === 'roomHasNew' && msg.room) {
        incUnread(msg.room);
      } else if (msg.type === 'openedFromNotification' && msg.room) {
        clearUnread(msg.room);
        window.location.href = `chat.html?room=${encodeURIComponent(msg.room)}`;
      }
    });
  }

    function logOut() {
      localStorage.removeItem('username');
      localStorage.removeItem('userid');
      window.location.href = "login.html";
    }
    document.getElementById('roomForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const input = document.getElementById('roomName');
      const room = input.value.trim();

      if (room.toLowerCase() === '/clear') {
        localStorage.removeItem('rooms');
        document.getElementById('roomsList').innerHTML = '';
        input.value = '';
        alert("Recent rooms cleared");
        return;
      }

      if (room) {
        clearUnread(room);
        saveToStorage('rooms', room);
        window.location.href = `chat.html?room=${encodeURIComponent(room)}`;
      }
    });

    function saveToStorage(key, value) {
      let items = JSON.parse(localStorage.getItem(key)) || [];
      if (!items.includes(value)) {
        items.unshift(value);
        if (items.length > 10) items = items.slice(0, 10);
        localStorage.setItem(key, JSON.stringify(items));
      }
      // Автоподписка на только что добавленную комнату
      if (key === 'rooms') {
        try { subscribeRooms([value]); } catch (_) {}
      }
    }

    function renderList(id, key) {
    const container = document.getElementById(id);
    const items = JSON.parse(localStorage.getItem(key)) || [];
    const unread = getUnreadMap();
    container.innerHTML = items.map(item => {
      const count = unread[item] || 0;
      const badge = count > 0
        ? `<span style="display:inline-flex;min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#ff8c00;color:#1e1e1e;font-weight:700;font-size:12px;line-height:18px;text-align:center;margin-left:8px;vertical-align:middle;justify-content:center;align-items:center;">${count}</span>`
        : '';
      return `
        <div class="list-item">
          <a href="#" data-room="${item}" class="room-link link-underline">${item}${badge}</a>
        </div>
      `;
    }).join('');
    // Attach click handlers to clear unread before navigating
    container.querySelectorAll('.room-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const r = a.getAttribute('data-room');
        clearUnread(r);
        window.location.href = 'chat.html?room=' + encodeURIComponent(r);
      });
    });
  }

    function goToAdminPanel() {
      window.location.href = "adminPanel.html";
    }

    function goToSettings() {
      window.location.href = "settings.html";
    }

    const currentUserId = localStorage.getItem('userID');
    if (currentUserId) {
      fetch('/check-admin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: currentUserId })
      })
      .then(res => res.json())
      .then(data => {
        if (Boolean(data.admin)) {
          document.getElementById('adminBtn').style.display = 'inline-block';
        }
      })
      .catch(err => {
        console.error("Failed to check admin:", err);
      });
    }

    renderList('roomsList', 'rooms');
  </script>
</body>
</html>
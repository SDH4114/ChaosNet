<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChaosNet - Register</title>
  <link rel="stylesheet" href="css/mainStyle.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
</head>
<body>
  <div class="register-container">
    <h2>Register</h2>
    <form id="register-form">
      <input type="text" id="nick" placeholder="Nick" required />
      <input type="text" id="id" placeholder="ID (e.g. AA0000)" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Register</button>
    </form>
    <div class="guest-link">
      <a href="login.html" class="link-underline">Log In</a>
    </div>
  </div>

  <script>
    function sanitize(input) {
      return input.replace(/[<>&"']/g, (char) => ({
        '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
      }[char]));
    }

    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      let nick = document.getElementById('nick').value.trim();
      let id = document.getElementById('id').value.trim();
      let password = document.getElementById('password').value.trim();

      const idPattern = /^[A-Z]{2}\d{4}$/;
      if (!idPattern.test(id)) {
        alert("User ID must be in the format AA0000.");
        return;
      }

      const nickPattern = /^[a-zA-Z0-9_]{3,30}$/;
      if (!nickPattern.test(nick)) {
        alert("Nick must be 3-30 characters and only letters, numbers, or underscore.");
        return;
      }

      if (password.length < 8 || !/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
        alert("Password must be at least 8 characters, with at least one uppercase letter and one number.");
        return;
      }

      nick = sanitize(nick);
      password = sanitize(password);

      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nick, id, password })
        });

        if (res.ok) {
          alert("User registered successfully!");
          localStorage.setItem("username", nick);
          localStorage.setItem("userID", id);
          window.location.href = 'login.html';
        } else {
          const text = await res.text();
          alert("Registration failed: " + text);
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
</html>